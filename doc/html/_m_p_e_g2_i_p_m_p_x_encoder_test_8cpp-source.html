<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&quot;DRM Plugin Architecture&quot;: MPEG2IPMPXEncoderTest.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>MPEG2IPMPXEncoderTest.cpp</h1><a href="_m_p_e_g2_i_p_m_p_x_encoder_test_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00017 <span class="preprocessor">#include "<a class="code" href="_m_p_e_g2_i_p_m_p_x_encoder_8h.html">MPEG2IPMPXEncoder.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="_x_m_l_factory_8h.html">XMLFactory.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="_thread_sync_factory_8h.html">ThreadSyncFactory.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="_i_cipher_8h.html">ICipher.h</a>"</span>
00021 
00022 <span class="keyword">using</span> <span class="keyword">namespace </span>DRMPlugin;
00023 <span class="keyword">using</span> <span class="keyword">namespace </span>MPEG2IPMPXDRMPlugin;
00024 
00025 <span class="preprocessor">#include &lt;iostream&gt;</span>
00026 <span class="preprocessor">#if defined (WIN32)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;crtdbg.h&gt;</span>
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00030 
<a name="l00058"></a><a class="code" href="_m_p_e_g2_i_p_m_p_x_encoder_test_8cpp.html#a0">00058</a> <span class="keywordtype">int</span> <a class="code" href="_m_p_e_g2_i_p_m_p_x_encoder_test_8cpp.html#a0">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {
00059 <span class="preprocessor">#if defined (WIN32)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#if defined(_DEBUG)</span>
00061 <span class="preprocessor"></span>        <span class="keywordtype">int</span> tempflag = _CrtSetDbgFlag( _CRTDBG_REPORT_FLAG );
00062         tempflag |= _CRTDBG_LEAK_CHECK_DF;
00063         _CrtSetDbgFlag( tempflag );
00064 
00065   _CrtSetReportMode( _CRT_ASSERT, _CRTDBG_MODE_WNDW );
00066   _CrtSetReportMode( _CRT_WARN, _CRTDBG_MODE_WNDW );
00067   _CrtSetReportMode( _CRT_ERROR, _CRTDBG_MODE_WNDW );
00068 <span class="comment">//  _CrtSetReportFile( _CRT_ASSERT, _CRTDBG_FILE_STDERR );</span>
00069 <span class="comment">//  _CrtSetReportFile( _CRT_WARN, _CRTDBG_FILE_STDERR );</span>
00070 <span class="comment">//  _CrtSetReportFile( _CRT_ERROR, _CRTDBG_FILE_STDERR );</span>
00071 <span class="preprocessor">#endif // _DEBUG</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#endif // WIN32</span>
00073 <span class="preprocessor"></span>
00074   std::string usageString = 
00075     <span class="stringliteral">" &lt;options&gt;\n"</span>
00076     <span class="stringliteral">"  Options:\n"</span>
00077     <span class="stringliteral">"  -W=xmlFileName           If encrypting, set name of the XML configuration file.\n"</span>
00078     <span class="stringliteral">"  -X=xmlPath;value         If encrypting, used to set sensitive information."</span>
00079     <span class="stringliteral">"  -Y=drm;enc               If encrypting, set drm method and encryption method\n"</span>
00080     <span class="stringliteral">"                           (openipmp/ctr, openipmp/bfs).\n"</span>;
00081 
00082   std::string drmMethod = <span class="stringliteral">""</span>, encMethod = <span class="stringliteral">""</span>, xmlFileName = <span class="stringliteral">""</span>;
00083   std::vector&lt;std::string&gt; sensitive;
00084   <span class="keywordtype">int</span> start = 0, end = 0;
00085 
00086   <span class="keywordtype">int</span> opt = 1;
00087   <span class="keywordflow">while</span> (opt &lt; argc) {
00088     std::string option = argv[opt++];
00089     <span class="keywordflow">if</span> (option.size() &lt; 4) {
00090       <span class="comment">//  Error.</span>
00091       std::cout &lt;&lt; <span class="stringliteral">"Invalid option!"</span> &lt;&lt; std::endl;
00092       <span class="keywordflow">continue</span>;
00093     }
00094     <span class="keywordflow">if</span> ((option[0] != <span class="charliteral">'-'</span>) || (option[2] != <span class="charliteral">'='</span>)) {
00095       <span class="comment">//  Error.</span>
00096       std::cout &lt;&lt; <span class="stringliteral">"Invalid option!"</span> &lt;&lt; std::endl;
00097       <span class="keywordflow">continue</span>;
00098     }
00099     <span class="keywordflow">if</span> (option[1] == <span class="charliteral">'W'</span>) {
00100       xmlFileName = option.data() + 3;
00101     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (option[1] == <span class="charliteral">'X'</span>) {
00102       sensitive.push_back(std::string(option.data() + 3));
00103     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (option[1] == <span class="charliteral">'Y'</span>) {
00104       start = 3;
00105       end = 3;
00106       <span class="comment">// find ';' delimiter (or end of string)</span>
00107       <span class="keywordflow">while</span> ((option[end] != 0) &amp;&amp; (option[end] != <span class="charliteral">';'</span>)) {
00108         end++;
00109       }
00110       <span class="keywordflow">if</span> (option[end] == 0) {
00111         <span class="comment">//  Error.</span>
00112         std::cout &lt;&lt; <span class="stringliteral">"Invalid -Y option!"</span> &lt;&lt; std::endl;
00113         <span class="keywordflow">continue</span>;
00114       }
00115       option[end] = <span class="charliteral">'\0'</span>;
00116 
00117       drmMethod = option.data() + start;
00118       encMethod = option.data() + end + 1;
00119     } <span class="keywordflow">else</span> {
00120       <span class="comment">//  Error.</span>
00121       std::cout &lt;&lt; <span class="stringliteral">"Invalid option "</span> &lt;&lt; option[1] &lt;&lt; std::endl;
00122       <span class="keywordflow">continue</span>;
00123     }
00124   }
00125 
00126   <span class="keywordflow">if</span> (drmMethod == <span class="stringliteral">""</span>) {
00127     std::cout &lt;&lt; <span class="stringliteral">"Missing drm method!"</span> &lt;&lt; std::endl;
00128     <span class="keywordflow">return</span> -1;
00129   }
00130   <span class="keywordflow">if</span> (encMethod == <span class="stringliteral">""</span>) {
00131     std::cout &lt;&lt; <span class="stringliteral">"Missing encryption method!"</span> &lt;&lt; std::endl;
00132     <span class="keywordflow">return</span> -1;
00133   }
00134 
00135   <a class="code" href="namespace_d_r_m_plugin.html#a9">EncMethod</a> encryption;
00136   <span class="keywordflow">if</span> (encMethod == <span class="stringliteral">"ctr"</span>) {
00137     encryption = <a class="code" href="namespace_d_r_m_plugin.html#a9a2">AES128CTR</a>;
00138   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (encMethod == <span class="stringliteral">"bfs"</span>) {
00139     encryption = <a class="code" href="namespace_d_r_m_plugin.html#a9a4">BLOWFISH</a>;
00140   } <span class="keywordflow">else</span> {
00141     std::cout &lt;&lt; <span class="stringliteral">"Invalid encryption method!"</span> &lt;&lt; std::endl;
00142     <span class="keywordflow">return</span> -1;
00143   }
00144   
00145   <a class="code" href="class_d_r_m_plugin_1_1_d_r_m_logger.html">DRMLogger</a> logger;
00146 
00147   <a class="code" href="class_d_r_m_plugin_1_1_i_x_m_l_document.html">IXMLDocument</a>* xmlDoc = 0;
00148   <a class="code" href="class_d_r_m_plugin_1_1_i_x_m_l_element.html">IXMLElement</a>* root = 0;
00149 
00150   <span class="keywordflow">if</span> (xmlFileName != <span class="stringliteral">""</span>) {
00151     xmlDoc = XMLFactory::DecodeDocumentFromFile(xmlFileName, logger);
00152 
00153     <span class="keywordflow">if</span> (xmlDoc == 0) {
00154       std::cout &lt;&lt; <span class="stringliteral">"Invalid XML configuration file!"</span> &lt;&lt; std::endl;
00155       <span class="keywordflow">return</span> -1;
00156     }
00157 
00158     root = xmlDoc-&gt;<a class="code" href="class_d_r_m_plugin_1_1_i_x_m_l_document.html#a1">GetRootElement</a>();
00159     <span class="keywordflow">if</span> (root == 0) {
00160       std::cout &lt;&lt; <span class="stringliteral">"Invalid XML configuration file!"</span> &lt;&lt; std::endl;
00161       <span class="keyword">delete</span> xmlDoc;
00162       <span class="keywordflow">return</span> -1;
00163     }
00164 
00165     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count  = 0;
00166     <span class="keywordflow">for</span> (count = 0; count &lt; sensitive.size(); count++) {
00167       <span class="keywordtype">char</span>* slash = strchr(sensitive[count].data(), <span class="charliteral">';'</span>);
00168       <span class="keywordflow">if</span> (slash == NULL) {
00169         std::cout &lt;&lt; <span class="stringliteral">"Invalid sensitive data!"</span> &lt;&lt; std::endl;
00170         <span class="keyword">delete</span> xmlDoc;
00171         <span class="keywordflow">return</span> -1;
00172       }
00173       std::string path = std::string(sensitive[count].begin(), std::string::iterator(slash));
00174       std::string value = std::string(std::string::iterator(++slash), sensitive[count].end());
00175       <span class="keywordflow">if</span> (root-&gt;<a class="code" href="class_d_r_m_plugin_1_1_i_x_m_l_element.html#a5">AddChildElement</a>(path, value) == 0) {
00176         std::cout &lt;&lt; <span class="stringliteral">"Invalid XML file!"</span> &lt;&lt; std::endl;
00177         <span class="keyword">delete</span> xmlDoc;
00178         <span class="keywordflow">return</span> -1;
00179       }
00180     }
00181   }
00182 
00183   FILE* sample = fopen(<span class="stringliteral">"sample.mpg"</span>, <span class="stringliteral">"wb"</span>);
00184   <span class="comment">//  Put 5*200*1024 data to sample file.</span>
00185   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; 5; i++) {
00186     ByteT buffer[200*1024];
00187     fwrite(buffer, 200*1024, 1, sample);
00188   }
00189   fclose(sample);
00190 
00191   MPEG2IPMPXTStreamEncoder tEncoder(logger);
00192 
00193   std::string input = <span class="stringliteral">"sample.mpg"</span>;
00194   <span class="keywordflow">if</span> (tEncoder.Encode(input, <span class="stringliteral">"tstream.mpg"</span>, root, encryption) == <span class="keyword">false</span>) {
00195     std::cout &lt;&lt; <span class="stringliteral">"Transport stream encode test failed."</span> &lt;&lt; std::endl;
00196     <span class="keywordflow">if</span> (xmlDoc != 0) <span class="keyword">delete</span> xmlDoc;
00197     <span class="keywordflow">return</span> -1;
00198   }
00199 
00200   MPEG2IPMPXPStreamEncoder pEncoder(logger);
00201 
00202   input = <span class="stringliteral">"sample.mpg"</span>;
00203   <span class="keywordflow">if</span> (pEncoder.Encode(input, <span class="stringliteral">"pstream.mpg"</span>, root, encryption) == <span class="keyword">false</span>) {
00204     std::cout &lt;&lt; <span class="stringliteral">"Program stream encode test failed."</span> &lt;&lt; std::endl;
00205     <span class="keywordflow">if</span> (xmlDoc != 0) <span class="keyword">delete</span> xmlDoc;
00206     <span class="keywordflow">return</span> -1;
00207   }
00208 
00209   std::cout &lt;&lt; <span class="stringliteral">"MPEG2 IPMPX DRM encode test passed."</span> &lt;&lt; std::endl;
00210 
00211   <span class="keywordflow">if</span> (xmlDoc != 0) <span class="keyword">delete</span> xmlDoc;
00212 
00213   <span class="keywordflow">return</span> 0;
00214 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jun 10 19:17:59 2006 for "DRM Plugin Architecture" by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
