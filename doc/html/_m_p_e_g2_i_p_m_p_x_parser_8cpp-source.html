<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&quot;DRM Plugin Architecture&quot;: MPEG2IPMPXParser.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>MPEG2IPMPXParser.cpp</h1><a href="_m_p_e_g2_i_p_m_p_x_parser_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00014 <span class="preprocessor">#include "<a class="code" href="_m_p_e_g2_i_p_m_p_x_parser_8h.html">MPEG2IPMPXParser.h</a>"</span>
00015 
00016 <span class="preprocessor">#include "<a class="code" href="_i_p_m_p_control_info_part_8h.html">IPMPControlInfoPart.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="_i_p_m_p_descriptor_8h.html">IPMPDescriptor.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="_i_p_m_p_stream_data_update_8h.html">IPMPStreamDataUpdate.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="_sig_cert_container_8h.html">SigCertContainer.h</a>"</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="_i_p_m_p_tool_manager_8h.html">IPMPToolManager.h</a>"</span>
00022 
00024 <span class="keyword">namespace </span>DRMPlugin {
00025 
00027 <span class="keyword">namespace </span>MPEG2IPMPXDRMPlugin {
00028 
<a name="l00042"></a><a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b0">00042</a> <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b0">MPEG2IPMPXParser::ParseByteSeq</a>(<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a>&amp; stream) {
00043   UInt64T len = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a30">GetSizeOfInstance</a>(0);
00044   <span class="keywordflow">return</span> stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a11">GetBytes</a>((UInt32T)len);
00045 }
00046 
<a name="l00055"></a><a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b1">00055</a> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_i_p_m_p_descriptor.html">IIPMPDescriptor</a>* <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b1">MPEG2IPMPXParser::ParseIPMPDescriptor</a>(<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a>&amp; stream) {
00056   ByteT tmp8 = stream.GetByte();
00057   <span class="keywordflow">if</span> (tmp8 != 41) {
00058     <span class="keywordflow">return</span> 0;
00059   }
00060 <span class="comment">//  tmp8 = stream.GetByte();</span>
00061 <span class="comment">//  ByteSeq data = stream.GetBytes(tmp8);</span>
00062   <span class="comment">//  Because of a bug in specifiations, we read 16-bit descriptor length.</span>
00063   Bit16T tmp16 = stream.GetBit16();
00064   <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> data = stream.GetBytes(tmp16);
00065 
00066   Bit32T descID = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a15">GetBit32</a>();
00067   <a class="code" href="class_d_r_m_plugin_1_1_bit128_t.html">Bit128T</a> toolID = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a16">GetBit128</a>();
00068   ByteT point = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00069   ByteT code = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00070   UInt16T len = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a17">GetUInt16</a>();
00071   <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> ipmpData = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a11">GetBytes</a>(len);
00072 
00073   <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_sig_cert_container.html">ISigCertContainer</a>* container = 0;
00074   <span class="keywordflow">if</span> (data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>() &amp; 0x80) {
00075     <span class="comment">//  Signed.</span>
00076     <span class="keywordflow">if</span> ((container = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b2">ParseSigCertContainer</a>(data)) == 0) {
00077       <span class="keywordflow">return</span> 0;
00078     }
00079   }
00080 
00081   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_descriptor.html">IPMPDescriptor</a>(descID, toolID, point, code, ipmpData, container);
00082 }
00083 
<a name="l00092"></a><a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b2">00092</a> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_sig_cert_container.html">ISigCertContainer</a>* <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b2">MPEG2IPMPXParser::ParseSigCertContainer</a>(<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a>&amp; stream) {
00093   std::vector&lt;ICertContainer*&gt; certs;
00094   <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> signature = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b0">ParseByteSeq</a>(stream);
00095   ByteT tmp8 = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00096   <span class="keywordflow">while</span> (tmp8 &gt; 0) {
00097     ByteT type = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00098     <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> cert = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b0">ParseByteSeq</a>(stream);
00099     certs.push_back(<span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_cert_container.html">CertContainer</a>(type, cert));
00100     tmp8--;
00101   }
00102   <a class="code" href="class_d_r_m_plugin_1_1_bit128_t.html">Bit128T</a> verify = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a16">GetBit128</a>();
00103   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_sig_cert_container.html">SigCertContainer</a>(signature, certs, verify);
00104 }
00105 
<a name="l00114"></a><a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b3">00114</a> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_i_p_m_p_stream_data_update.html">IIPMPStreamDataUpdate</a>* <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b3">MPEG2IPMPXParser::ParseIPMPStreamDataUpdate</a>(<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a>&amp; stream) {
00115   Bit32T descID = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a15">GetBit32</a>();
00116   UInt16T len = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a17">GetUInt16</a>();
00117   <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> ipmpData = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a11">GetBytes</a>(len);
00118   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_stream_data_update.html">IPMPStreamDataUpdate</a>(descID, ipmpData);
00119 }
00120 
<a name="l00133"></a><a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_t_stream_parser.html#a2">00133</a> <span class="keywordtype">bool</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_t_stream_parser.html#a2">MPEG2IPMPXTStreamParser::ParseStream</a>(<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a>&amp; stream) {
00134   <span class="comment">//  Since this is just a test we will assume that first we parse control</span>
00135   <span class="comment">//  info intermediate parts, then control info last part, then IPMP</span>
00136   <span class="comment">// descriptor.</span>
00137   <span class="keywordflow">try</span> {
00138     <span class="comment">//  Parse control info parts.</span>
00139     <span class="keywordtype">bool</span> lastParsed = <span class="keyword">false</span>;
00140     <span class="keywordflow">while</span> (lastParsed == <span class="keyword">false</span>) {
00141       ByteT tableID = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00142       Bit16T tmp16 = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a13">GetBit16</a>();
00143       <span class="keywordtype">bool</span> syntax = ((tmp16 &amp; 0x8000) == 0)? (<span class="keyword">false</span>): (<span class="keyword">true</span>);
00144       UInt16T sectionLength = (tmp16 &amp; 0xfff);
00145       <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> data = stream.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a11">GetBytes</a>(sectionLength);
00146       ByteT tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00147       Bit5T version = (tmp8 &gt;&gt; 1) &amp; 0x1f;
00148       <span class="keywordtype">bool</span> current = ((tmp8 &amp; 0x1) == 0)? (<span class="keyword">false</span>): (<span class="keyword">true</span>);
00149       ByteT sectionNum = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00150       ByteT lastNum = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00151       UInt16T totalLen = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a17">GetUInt16</a>();
00152       UInt16T thisLen = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a17">GetUInt16</a>();
00153       <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> classes = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a11">GetBytes</a>(thisLen);
00154       <span class="keywordflow">if</span> (sectionNum == lastNum) {
00155         <span class="comment">//  Last section.</span>
00156         <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_sig_cert_container.html">ISigCertContainer</a>* container = 0;
00157         tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00158         <span class="keywordflow">if</span> (tmp8 &amp; 0x80) {
00159           <span class="comment">//  Signed.</span>
00160           <span class="keywordflow">if</span> ((container = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b2">ParseSigCertContainer</a>(data)) == 0) {
00161             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00162           }
00163         }
00164         UInt32T crc = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a18">GetUInt32</a>();
00165         <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_last_t_stream_i_p_m_p_control_info_part.html">ILastTStreamIPMPControlInfoPart</a>* last =
00166           <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_last_t_stream_i_p_m_p_control_info_part.html">LastTStreamIPMPControlInfoPart</a>(version, current, sectionNum,
00167           classes, crc, tableID, syntax, totalLen, container);
00168         lastParsed = <span class="keyword">true</span>;
00169 
00170         <span class="comment">//  Pass control info part to manager.</span>
00171         <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a10">ProcessLastTStreamIPMPControlInfoPart</a>(last) == <span class="keyword">false</span>) {
00172           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00173         }
00174       } <span class="keywordflow">else</span> {
00175         UInt32T crc = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a18">GetUInt32</a>();
00176         <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_inter_t_stream_i_p_m_p_control_info_part.html">IInterTStreamIPMPControlInfoPart</a>* inter =
00177           <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_inter_t_stream_i_p_m_p_control_info_part.html">InterTStreamIPMPControlInfoPart</a>(version, current, sectionNum,
00178           classes, crc, tableID, syntax, totalLen, lastNum);
00179 
00180         <span class="comment">//  Pass control info part to manager.</span>
00181         <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a11">ProcessInterTStreamIPMPControlInfoPart</a>(inter) == <span class="keyword">false</span>) {
00182           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00183         }
00184       }
00185     }
00186 
00187     <span class="comment">//  Parse IPMP descriptor.</span>
00188     <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_i_p_m_p_descriptor.html">IIPMPDescriptor</a>* ipmpDesc = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b1">ParseIPMPDescriptor</a>(stream);
00189     <span class="keywordflow">if</span> (ipmpDesc == 0) {
00190       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00191     }
00192 
00193     <span class="comment">//  Save control point for later reference.</span>
00194     ByteT control = ipmpDesc-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_i_p_m_p_descriptor.html#a6">GetControlPoint</a>();
00195 
00196     <span class="comment">//  Pass IPMP dscriptor to manager.</span>
00197     <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a14">ProcessIPMPDescriptor</a>(ipmpDesc) == <span class="keyword">false</span>) {
00198       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00199     }
00200 
00201     <span class="comment">//  Read data and pass it to tool manager.</span>
00202     <span class="keywordflow">while</span> (stream.GetLength() &gt; 0) {
00203       UInt32T length = stream.GetUInt32();
00204       <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> encrypted = stream.GetBytes(length), plain;
00205       <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a16">ProcessData</a>(control, encrypted, plain) == <span class="keyword">false</span>) {
00206         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00207       }
00208     }
00209 
00210     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00211   }
00212   <span class="keywordflow">catch</span> (<a class="code" href="class_d_r_m_plugin_1_1_byte_seq_exception.html">ByteSeqException</a>) {
00213     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00214   }
00215 }
00216 
<a name="l00229"></a><a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_p_stream_parser.html#a2">00229</a> <span class="keywordtype">bool</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_p_stream_parser.html#a2">MPEG2IPMPXPStreamParser::ParseStream</a>(<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a>&amp; stream) {
00230   <span class="comment">//  Since this is just a test we will assume that first we parse control</span>
00231   <span class="comment">//  info intermediate parts, then control info last part, then IPMP</span>
00232   <span class="comment">// descriptor.</span>
00233   <span class="keywordflow">try</span> {
00234     <span class="comment">//  Parse control info parts.</span>
00235     <span class="keywordtype">bool</span> lastParsed = <span class="keyword">false</span>;
00236     <span class="keywordflow">while</span> (lastParsed == <span class="keyword">false</span>) {
00237       <a class="code" href="class_d_r_m_plugin_1_1_bit24_t.html">Bit24T</a> prefix = stream.GetBit24();
00238       ByteT streamID = stream.GetByte();
00239       UInt16T packetLength = stream.GetUInt16();
00240       <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> data = stream.GetBytes(packetLength);
00241       Bit16T tmp16 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a13">GetBit16</a>();
00242       <span class="keywordtype">bool</span> pesFlag = ((tmp16 &amp; 0x1) == 0)? (<span class="keyword">false</span>): (<span class="keyword">true</span>);
00243       ByteT tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00244       tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00245       <span class="keywordtype">bool</span> pesFlag2 = ((tmp8 &amp; 0x1) == 0)? (<span class="keyword">false</span>): (<span class="keyword">true</span>);
00246       tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00247       tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00248       <span class="keywordtype">bool</span> extFlag = ((tmp8 &amp; 0x80) == 0)? (<span class="keyword">false</span>): (<span class="keyword">true</span>);
00249       ByteT ext = (tmp8 &amp; 0x7f);
00250       tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00251       Bit5T version = (tmp8 &gt;&gt; 3);
00252       <span class="keywordtype">bool</span> next = (((tmp8 &gt;&gt; 2) &amp; 0x1) == 0)? (<span class="keyword">false</span>): (<span class="keyword">true</span>);
00253       ByteT packetNum = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00254       ByteT lastNum = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00255       UInt16T thisLen = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a17">GetUInt16</a>();
00256       <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> classes = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a11">GetBytes</a>(thisLen);
00257       <span class="keywordflow">if</span> (packetNum == lastNum) {
00258         <span class="comment">//  Last section.</span>
00259         <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_sig_cert_container.html">ISigCertContainer</a>* container = 0;
00260         tmp8 = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a12">GetByte</a>();
00261         <span class="keywordflow">if</span> (tmp8 &amp; 0x80) {
00262           <span class="comment">//  Signed.</span>
00263           <span class="keywordflow">if</span> ((container = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b2">ParseSigCertContainer</a>(data)) == 0) {
00264             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00265           }
00266         }
00267         UInt32T crc = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a18">GetUInt32</a>();
00268         <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_last_p_stream_i_p_m_p_control_info_part.html">ILastPStreamIPMPControlInfoPart</a>* last =
00269           <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_last_p_stream_i_p_m_p_control_info_part.html">LastPStreamIPMPControlInfoPart</a>(version, next, packetNum,
00270           classes, crc, prefix, streamID, pesFlag, pesFlag2, extFlag, ext,
00271           container);
00272         lastParsed = <span class="keyword">true</span>;
00273 
00274         <span class="comment">//  Pass control info part to manager.</span>
00275         <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a12">ProcessLastPStreamIPMPControlInfoPart</a>(last) == <span class="keyword">false</span>) {
00276           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00277         }
00278       } <span class="keywordflow">else</span> {
00279         UInt32T crc = data.<a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html#a18">GetUInt32</a>();
00280         <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_inter_p_stream_i_p_m_p_control_info_part.html">IInterPStreamIPMPControlInfoPart</a>* inter =
00281           <span class="keyword">new</span> <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_inter_p_stream_i_p_m_p_control_info_part.html">InterPStreamIPMPControlInfoPart</a>(version, next, packetNum,
00282           classes, crc, prefix, streamID, pesFlag, pesFlag2, extFlag, ext,
00283           lastNum);
00284 
00285         <span class="comment">//  Pass control info part to manager.</span>
00286         <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a13">ProcessInterPStreamIPMPControlInfoPart</a>(inter) == <span class="keyword">false</span>) {
00287           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00288         }
00289       }
00290     }
00291 
00292     <span class="comment">//  Parse IPMP descriptor.</span>
00293     <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_i_p_m_p_descriptor.html">IIPMPDescriptor</a>* ipmpDesc = <a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#b1">ParseIPMPDescriptor</a>(stream);
00294     <span class="keywordflow">if</span> (ipmpDesc == 0) {
00295       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00296     }
00297 
00298     <span class="comment">//  Save control point for later reference.</span>
00299     ByteT control = ipmpDesc-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_i_p_m_p_descriptor.html#a6">GetControlPoint</a>();
00300 
00301     <span class="comment">//  Pass IPMP dscriptor to manager.</span>
00302     <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a14">ProcessIPMPDescriptor</a>(ipmpDesc) == <span class="keyword">false</span>) {
00303       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00304     }
00305 
00306     <span class="comment">//  Read data and pass it to tool manager.</span>
00307     <span class="keywordflow">while</span> (stream.GetLength() &gt; 0) {
00308       UInt32T length = stream.GetUInt32();
00309       <a class="code" href="class_d_r_m_plugin_1_1_byte_seq.html">ByteSeq</a> encrypted = stream.GetBytes(length), plain;
00310       <span class="keywordflow">if</span> (<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_parser.html#p0">manager</a>-&gt;<a class="code" href="class_d_r_m_plugin_1_1_m_p_e_g2_i_p_m_p_x_d_r_m_plugin_1_1_i_p_m_p_tool_manager.html#a16">ProcessData</a>(control, encrypted, plain) == <span class="keyword">false</span>) {
00311         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00312       }
00313     }
00314 
00315     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00316   }
00317   <span class="keywordflow">catch</span> (<a class="code" href="class_d_r_m_plugin_1_1_byte_seq_exception.html">ByteSeqException</a>) {
00318     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00319   }
00320 }
00321 
00322 } <span class="comment">// namespace MPEG2IPMPXDRMPlugin</span>
00323 
00324 } <span class="comment">// namespace DRMPlugin</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jun 10 19:17:59 2006 for "DRM Plugin Architecture" by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
